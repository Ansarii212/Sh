<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ملف الإنجاز</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      background-color: #fdf7f0;
      padding: 20px;
      direction: rtl;
    }
    .section {
      border: 2px solid #a67c52;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 20px;
      background-color: #fff8f0;
    }
    .dropdown {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      background-color: #fffaf4;
      border: 1px solid #d9bfa3;
      border-radius: 5px;
    }
    .desc {
      margin: 10px 0;
      color: #5a4632;
    }
    .upload-group {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }
    .upload-group input[type="text"] {
      flex: 1;
      padding: 5px;
    }
    .upload-group input[type="file"] {
      width: 120px;
    }
    .btn {
      margin: 5px;
      padding: 10px 15px;
      background-color: #a67c52;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .btn:hover {
      background-color: #8b6543;
    }
    #qrCanvas {
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h1 style="text-align:center;">ملف الإنجاز</h1>
  <label>رقم الجوال:</label>
  <input type="text" id="phone" style="width: 100%; padding: 8px; margin-bottom: 20px;" placeholder="05XXXXXXXX">

  <div id="sections-container"></div>

  <button class="btn" onclick="generateHTMLPage()">توليد صفحة الإنجاز</button>
  <button class="btn" onclick="window.print()">طباعة</button>
  <button class="btn" onclick="sharePage()">مشاركة</button>

  <div id="resultLink" style="margin-top: 20px;"></div>
  <canvas id="qrCanvas"></canvas>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCr4T8GLRxtf_6LNrokjKvmBOwSkuGO5yQ",
      authDomain: "hamsa-6009e.firebaseapp.com",
      databaseURL: "https://hamsa-6009e-default-rtdb.firebaseio.com",
      projectId: "hamsa-6009e",
      storageBucket: "hamsa-6009e.firebasestorage.app",
      messagingSenderId: "998163671039",
      appId: "1:998163671039:web:d1930ea5b71a3a3fc729ca",
      measurementId: "G-PD1QB8X0FE"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const titles = [
      "الدرس الأول", "الدرس الثاني", "الدرس الثالث", "الدرس الرابع",
      "الدرس الخامس", "الدرس السادس", "الدرس السابع", "الدرس الثامن",
      "الدرس التاسع", "الدرس العاشر", "الدرس الحادي عشر"
    ];

    const sectionsContainer = document.getElementById("sections-container");

    titles.forEach((title, index) => {
      const section = document.createElement("div");
      section.className = "section";
      section.innerHTML = `
        <select class="dropdown">
          <option>${title}</option>
        </select>
        <div class="desc">شرح نصي للدرس.</div>
        <div class="upload-group">
          <input type="text" placeholder="اسم الصورة 1">
          <input type="file" accept="image/*">
        </div>
        <div class="upload-group">
          <input type="text" placeholder="اسم الصورة 2">
          <input type="file" accept="image/*">
        </div>
        <div class="upload-group">
          <input type="text" placeholder="اسم الصورة 3">
          <input type="file" accept="image/*">
        </div>
      `;
      sectionsContainer.appendChild(section);
    });

    function generateHTMLPage() {
      const phone = document.getElementById("phone").value.trim();
      if (!phone) {
        alert("يرجى إدخال رقم الجوال");
        return;
      }

      const data = { phone: phone, sections: [] };

      const sections = document.querySelectorAll(".section");
      sections.forEach(section => {
        const title = section.querySelector("select").value;
        const inputs = section.querySelectorAll("input[type='text']");
        const files = section.querySelectorAll("input[type='file']");
        const images = [];

        for (let i = 0; i < inputs.length; i++) {
          const name = inputs[i].value;
          const file = files[i].files[0];
          const reader = new FileReader();
          reader.onload = (function(imgName) {
            return function(e) {
              images.push({ name: imgName, url: e.target.result });
              if (images.length === 3) {
                data.sections.push({ title: title, images: images });
                if (data.sections.length === sections.length) {
                  const key = phone;
                  db.ref("enjaz/" + key).set(data, () => {
                    const pageUrl = location.href + "?id=" + phone;
                    document.getElementById("resultLink").innerHTML = `<a href="${pageUrl}" target="_blank">${pageUrl}</a>`;
                    const qr = new QRious({ element: document.getElementById("qrCanvas"), value: pageUrl, size: 200 });
                  });
                }
              }
            }
          })(name);
          if (file) reader.readAsDataURL(file);
        }
      });
    }

    function sharePage() {
      const link = document.getElementById("resultLink").textContent;
      if (navigator.share) {
        navigator.share({
          title: "ملف الإنجاز",
          text: "رابط ملف الإنجاز",
          url: link
        });
      } else {
        alert("المشاركة غير مدعومة على هذا الجهاز");
      }
    }
  </script>
</body>
</html>
